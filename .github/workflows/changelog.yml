# Nombre del workflow que aparecerÃ¡ en la pestaÃ±a "Actions" de GitHub
name: 'Generate Changelog'

# Activador: Â¿CuÃ¡ndo debe ejecutarse este workflow?
on:
  push:
    tags:
      - 'v*.*.*' # Se activa al empujar cualquier tag que empiece con "v", como v1.0.0

# Permisos del Job
permissions:
  contents: write # Permite a la acciÃ³n escribir en el repositorio (para crear el release)
  pull-requests: read # Permite leer los pull requests asociados

# Trabajos a realizar
jobs:
  # Nombre del trabajo
  update_changelog:
    # MÃ¡quina virtual donde se ejecutarÃ¡
    runs-on: ubuntu-latest

    # Pasos que ejecutarÃ¡ el trabajo
    steps:
      # 1. Clona tu repositorio para que el workflow tenga acceso al cÃ³digo
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Necesitamos el historial completo para comparar todos los commits
          fetch-depth: 0

      # 2. La acciÃ³n principal que genera el changelog y crea un Release
      - name: Generate Changelog
        id: gitmoji-changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          # Token de GitHub necesario para leer commits
          token: ${{ secrets.GITHUB_TOKEN }}
          # ConfiguraciÃ³n para reconocer gitmojis
          configuration: |
            {
              "categories": [
                {
                  "title": "## âœ¨ Features",
                  "labels": [],
                  "rules": [{"pattern": "^(âœ¨|:sparkles:).*", "flags": ["dotAll"]}]
                },
                {
                  "title": "## ğŸ› Bug Fixes", 
                  "labels": [],
                  "rules": [{"pattern": "^(ğŸ›|:bug:).*", "flags": ["dotAll"]}]
                },
                {
                  "title": "## ğŸ’„ UI/UX",
                  "labels": [],
                  "rules": [{"pattern": "^(ğŸ’„|:lipstick:).*", "flags": ["dotAll"]}]
                },
                {
                  "title": "## âš¡ Performance",
                  "labels": [],
                  "rules": [{"pattern": "^(âš¡|:zap:).*", "flags": ["dotAll"]}]
                },
                {
                  "title": "## ğŸ“ Documentation",
                  "labels": [],
                  "rules": [{"pattern": "^(ğŸ“|:memo:).*", "flags": ["dotAll"]}]
                },
                {
                  "title": "## ğŸ”§ Configuration",
                  "labels": [],
                  "rules": [{"pattern": "^(ğŸ”§|:wrench:).*", "flags": ["dotAll"]}]
                },
                {
                  "title": "## ğŸ¨ Code Style",
                  "labels": [],
                  "rules": [{"pattern": "^(ğŸ¨|:art:).*", "flags": ["dotAll"]}]
                },
                {
                  "title": "## ğŸŒ Internationalization",
                  "labels": [],
                  "rules": [{"pattern": "^(ğŸŒ|:globe_with_meridians:).*", "flags": ["dotAll"]}]
                },
                {
                  "title": "## ğŸ“± Responsive",
                  "labels": [],
                  "rules": [{"pattern": "^(ğŸ“±|:iphone:).*", "flags": ["dotAll"]}]
                },
                {
                  "title": "## ğŸ‰ Initial",
                  "labels": [],
                  "rules": [{"pattern": "^(ğŸ‰|:tada:).*", "flags": ["dotAll"]}]
                },
                {
                  "title": "## ğŸ§ª Testing",
                  "labels": [],
                  "rules": [{"pattern": "^(ğŸ§ª|:test_tube:).*", "flags": ["dotAll"]}]
                },
                {
                  "title": "## ğŸ”’ Security",
                  "labels": [],
                  "rules": [{"pattern": "^(ğŸ”’|:lock:).*", "flags": ["dotAll"]}]
                },
                {
                  "title": "## ğŸš€ Other Changes",
                  "labels": [],
                  "rules": [{"pattern": ".*", "flags": ["dotAll"]}]
                }
              ]
            }

      # 3. Crea un GitHub Release con el changelog generado
      - name: Create a GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          # El nombre del Release (serÃ¡ el mismo que el tag)
          name: Release ${{ github.ref_name }}

          # El contenido del Release serÃ¡ el changelog del paso anterior
          body: ${{ steps.gitmoji-changelog.outputs.changelog }}

          # El tag se toma automÃ¡ticamente del evento que disparÃ³ el workflow
          tag_name: ${{ github.ref_name }}

          # Hacer el release como draft si se desea revisiÃ³n manual (opcional)
          # draft: false
        env:
          # Token de autenticaciÃ³n de GitHub (provisto automÃ¡ticamente)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
